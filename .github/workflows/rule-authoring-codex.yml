name: Rule Authoring (Codex)

on:
  workflow_dispatch:
    inputs:
      base_ref:
        description: "Optional base ref for verify-input diff (example: origin/main)"
        required: false
        default: ""
        type: string

env:
  BASE_REF: ${{ inputs.base_ref }}
  NO_GO_HISTORY_PATH: prompts/references/no-go-history.md

# Design intent for 4 Codex phases:
# - phase1 (ideate+plan): establish one deterministic target and plan artifact.
# - phase2 (spec): lock the contract before implementation.
# - phase3 (impl): implement against fixed spec with test feedback.
# - phase4 (verify): evaluate only verify-input evidence and gate PR finalization.
# Splitting phases reduces prompt/context mixing and makes each artifact auditable.
jobs:
  phase1_ideate_plan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      rule_id: ${{ steps.rule_meta.outputs.rule_id }}
      rule_idea: ${{ steps.rule_meta.outputs.rule_idea }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Prepare workspace
        run: |
          mkdir -p target/codex-workflow/prompts
          mkdir -p target/codex-workflow/output
          default_branch="${{ github.event.repository.default_branch }}"
          git fetch --quiet origin "${default_branch}"
          if git show "origin/${default_branch}:${NO_GO_HISTORY_PATH}" > /tmp/no-go-history.md 2>/dev/null; then
            mkdir -p "$(dirname "${NO_GO_HISTORY_PATH}")"
            mv /tmp/no-go-history.md "${NO_GO_HISTORY_PATH}"
          fi
          find src/rules -mindepth 2 -maxdepth 2 -name plan.md | LC_ALL=C sort > target/codex-workflow/baseline-plan-files.txt

      - name: Write phase-1 prompt (ideate + plan)
        run: |
          cat > target/codex-workflow/prompts/phase1-ideate-plan.md <<'PROMPT'
          You are Codex in this repository.

          Use both base prompts below:
          - `./prompts/ideate-rule.md`
          - `./prompts/authoring-plan.md`

          Phase scope:
          1. Ideate one rule (`rule-id`, `rule idea`) based on `./prompts/ideate-rule.md`.
             - Read and use `./prompts/references/no-go-history.md` if present.
             - Avoid duplicate or near-duplicate ideas listed in the No-Go history.
          2. Create `src/rules/<RULE_ID>/plan.md` based on `./prompts/authoring-plan.md`.
          3. Do not create or modify `spec.md` in this phase.
          4. Do not implement or verify in this phase.

          Final response format (strict):
          rule-id: <snake_case_id>
          rule idea: <one short sentence>
          plan-path: src/rules/<snake_case_id>/plan.md
          PROMPT

      - name: Phase 1 - Ideate + Plan
        id: codex_phase1
        uses: openai/codex-action@086169432f1d2ab2f4057540b1754d550f6a1189 # v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          safety-strategy: drop-sudo
          prompt-file: target/codex-workflow/prompts/phase1-ideate-plan.md
          output-file: target/codex-workflow/output/phase1-final-message.txt
          sandbox: workspace-write
          codex-args: --full-auto

      - name: Extract rule-id and rule idea
        id: rule_meta
        shell: bash
        run: |
          set -euo pipefail
          msg_file="target/codex-workflow/output/phase1-final-message.txt"

          rule_id="$(sed -nE 's/^[[:space:]]*rule-id:[[:space:]]*([a-z0-9_]+)[[:space:]]*$/\1/p' "${msg_file}" | head -n1)"
          rule_idea="$(sed -nE 's/^[[:space:]]*rule idea:[[:space:]]*(.+)[[:space:]]*$/\1/p' "${msg_file}" | head -n1)"

          if [[ -z "${rule_id}" ]]; then
            find src/rules -mindepth 2 -maxdepth 2 -name plan.md | LC_ALL=C sort > target/codex-workflow/after-phase1-plan-files.txt
            new_plan="$(comm -13 target/codex-workflow/baseline-plan-files.txt target/codex-workflow/after-phase1-plan-files.txt | head -n1 || true)"
            if [[ -n "${new_plan}" ]]; then
              rule_id="$(basename "$(dirname "${new_plan}")")"
            fi
          fi

          if [[ -z "${rule_id}" ]]; then
            echo "Failed to determine rule-id from phase-1 output." >&2
            exit 1
          fi

          if [[ -z "${rule_idea}" ]]; then
            rule_idea="Autogenerated rule idea for ${rule_id}"
          fi

          if [[ ! -f "src/rules/${rule_id}/plan.md" ]]; then
            echo "Expected plan file missing: src/rules/${rule_id}/plan.md" >&2
            exit 1
          fi

          {
            echo "rule_id=${rule_id}"
            echo "rule_idea<<EOF"
            echo "${rule_idea}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

          cat > target/codex-workflow/output/rule-meta.txt <<EOF
          rule-id: ${rule_id}
          rule idea: ${rule_idea}
          EOF

      - name: Capture cumulative patch (phase1)
        shell: bash
        run: |
          set -euo pipefail
          git add -A
          git reset -- "${NO_GO_HISTORY_PATH}" >/dev/null 2>&1 || true
          git diff --cached --binary > target/codex-workflow/output/phase1-cumulative.patch

      - name: Upload phase-1 artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: codex-phase1
          path: |
            target/codex-workflow/prompts/phase1-ideate-plan.md
            target/codex-workflow/output/phase1-final-message.txt
            target/codex-workflow/output/rule-meta.txt
            target/codex-workflow/output/phase1-cumulative.patch
            prompts/references/no-go-history.md
            src/rules/${{ steps.rule_meta.outputs.rule_id }}/plan.md
          if-no-files-found: warn

  phase2_spec:
    runs-on: ubuntu-latest
    needs: phase1_ideate_plan
    permissions:
      contents: read
    outputs:
      rule_id: ${{ needs.phase1_ideate_plan.outputs.rule_id }}
      rule_idea: ${{ needs.phase1_ideate_plan.outputs.rule_idea }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Download phase-1 artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: codex-phase1
          path: target/codex-workflow/from-phase1

      - name: Apply cumulative patch from phase1
        shell: bash
        run: |
          set -euo pipefail
          patch_file="target/codex-workflow/from-phase1/target/codex-workflow/output/phase1-cumulative.patch"
          if [[ ! -f "${patch_file}" ]]; then
            echo "Missing patch: ${patch_file}" >&2
            exit 1
          fi
          if [[ -s "${patch_file}" ]]; then
            git apply --whitespace=nowarn "${patch_file}"
          else
            echo "phase1 patch is empty; skipping apply."
          fi

      - name: Write phase-2 prompt (plan -> spec)
        env:
          RULE_ID: ${{ needs.phase1_ideate_plan.outputs.rule_id }}
          RULE_IDEA: ${{ needs.phase1_ideate_plan.outputs.rule_idea }}
        run: |
          mkdir -p target/codex-workflow/prompts target/codex-workflow/output
          cat > target/codex-workflow/prompts/phase2-spec.md <<EOF
          You are Codex in this repository.

          Use \`./prompts/authoring-spec.md\` as the base prompt and follow it strictly.

          Inputs:
          - rule-id: ${RULE_ID}
          - rule idea: ${RULE_IDEA}
          - plan path: src/rules/${RULE_ID}/plan.md

          Phase scope:
          1. Create or update only \`src/rules/${RULE_ID}/spec.md\`.
          2. Keep exact section order required by \`./prompts/authoring-spec.md\`.
          3. Do not implement, do not run verify, do not edit plan in this phase.

          Final response format (strict):
          rule-id: ${RULE_ID}
          spec-path: src/rules/${RULE_ID}/spec.md
          EOF

      - name: Phase 2 - Spec from Plan
        id: codex_phase2
        uses: openai/codex-action@086169432f1d2ab2f4057540b1754d550f6a1189 # v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          safety-strategy: drop-sudo
          prompt-file: target/codex-workflow/prompts/phase2-spec.md
          output-file: target/codex-workflow/output/phase2-final-message.txt
          sandbox: workspace-write
          codex-args: --full-auto

      - name: Ensure spec exists
        run: |
          test -f "src/rules/${{ needs.phase1_ideate_plan.outputs.rule_id }}/spec.md"

      - name: Capture cumulative patch (phase2)
        shell: bash
        run: |
          set -euo pipefail
          git add -A
          git diff --cached --binary > target/codex-workflow/output/phase2-cumulative.patch

      - name: Upload phase-2 artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: codex-phase2
          path: |
            target/codex-workflow/prompts/phase2-spec.md
            target/codex-workflow/output/phase2-final-message.txt
            target/codex-workflow/output/phase2-cumulative.patch
            src/rules/${{ needs.phase1_ideate_plan.outputs.rule_id }}/plan.md
            src/rules/${{ needs.phase1_ideate_plan.outputs.rule_id }}/spec.md
          if-no-files-found: warn

  phase3_impl:
    runs-on: ubuntu-latest
    needs: phase2_spec
    permissions:
      contents: read
    outputs:
      rule_id: ${{ needs.phase2_spec.outputs.rule_id }}
      rule_idea: ${{ needs.phase2_spec.outputs.rule_idea }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          distribution: "temurin"
          java-version-file: ".java-version"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Download phase-2 artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: codex-phase2
          path: target/codex-workflow/from-phase2

      - name: Apply cumulative patch from phase2
        shell: bash
        run: |
          set -euo pipefail
          patch_file="target/codex-workflow/from-phase2/target/codex-workflow/output/phase2-cumulative.patch"
          if [[ ! -f "${patch_file}" ]]; then
            echo "Missing patch: ${patch_file}" >&2
            exit 1
          fi
          if [[ -s "${patch_file}" ]]; then
            git apply --whitespace=nowarn "${patch_file}"
          else
            echo "phase2 patch is empty; skipping apply."
          fi

      - name: Write phase-3 prompt (spec -> impl)
        env:
          RULE_ID: ${{ needs.phase2_spec.outputs.rule_id }}
        run: |
          mkdir -p target/codex-workflow/prompts target/codex-workflow/output
          cat > target/codex-workflow/prompts/phase3-impl.md <<EOF
          You are Codex in this repository.

          Use \`./prompts/authoring-impl.md\` as the base prompt and follow it strictly.

          Inputs:
          - rule-id: ${RULE_ID}
          - spec path: src/rules/${RULE_ID}/spec.md

          Phase scope:
          1. Implement \`src/rules/${RULE_ID}/spec.md\` as contract.
          2. Add/adjust tests as needed.
          3. Run \`cargo fmt\` and \`cargo test\`.
          4. Do not run verify skill in this phase.

          Final response format (strict):
          rule-id: ${RULE_ID}
          impl-status: done
          EOF

      - name: Phase 3 - Implement from Spec
        id: codex_phase3
        uses: openai/codex-action@086169432f1d2ab2f4057540b1754d550f6a1189 # v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          safety-strategy: drop-sudo
          prompt-file: target/codex-workflow/prompts/phase3-impl.md
          output-file: target/codex-workflow/output/phase3-final-message.txt
          sandbox: workspace-write
          codex-args: --full-auto

      - name: Phase 3 validation - cargo test
        shell: bash
        run: |
          set +e
          cargo test > target/codex-workflow/output/phase3-cargo-test.txt 2>&1
          phase3_test_exit=$?
          set -e
          echo "phase3 cargo test exit code: ${phase3_test_exit}"
          echo "${phase3_test_exit}" > target/codex-workflow/output/phase3-cargo-test.exitcode

      - name: Prepare verify-input and reports
        env:
          RULE_ID: ${{ needs.phase2_spec.outputs.rule_id }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p verify-input/reports
          if [[ -n "${BASE_REF}" ]]; then
            scripts/prepare-verify-input.sh "${RULE_ID}" "${BASE_REF}"
          else
            scripts/prepare-verify-input.sh "${RULE_ID}"
          fi

          set +e
          cargo build > verify-input/reports/cargo-build.txt 2>&1
          build_exit=$?

          cargo test > verify-input/reports/cargo-test.txt 2>&1
          test_exit=$?

          if ! command -v cargo-audit >/dev/null 2>&1; then
            cargo install cargo-audit --locked
          fi

          cargo audit --format sarif > verify-input/reports/cargo-audit.sarif
          audit_exit=$?
          if [[ ${audit_exit} -ne 0 ]]; then
            cat > verify-input/reports/cargo-audit.sarif <<'SARIF'
          {"$schema":"https://json.schemastore.org/sarif-2.1.0.json","version":"2.1.0","runs":[{"tool":{"driver":{"name":"cargo-audit"}},"results":[{"level":"error","message":{"text":"cargo audit failed in workflow"}}]}]}
          SARIF
          fi
          set -e

          cat > verify-input/reports/command-status.txt <<EOF
          cargo build exit code: ${build_exit}
          cargo test exit code: ${test_exit}
          cargo audit exit code: ${audit_exit}
          EOF

      - name: Capture cumulative patch (phase3)
        shell: bash
        run: |
          set -euo pipefail
          git add -A
          git diff --cached --binary > target/codex-workflow/output/phase3-cumulative.patch

      - name: Upload phase-3 artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: codex-phase3
          path: |
            target/codex-workflow/prompts/phase3-impl.md
            target/codex-workflow/output/phase3-final-message.txt
            target/codex-workflow/output/phase3-cargo-test.txt
            target/codex-workflow/output/phase3-cargo-test.exitcode
            target/codex-workflow/output/phase3-cumulative.patch
            src/rules/${{ needs.phase2_spec.outputs.rule_id }}/
            src/rules/mod.rs
            tests/snapshots/callgraph.sarif
            verify-input/
          if-no-files-found: warn

  pr_open:
    runs-on: ubuntu-latest
    needs: phase3_impl
    environment: codex
    permissions:
      contents: write
      pull-requests: write
    outputs:
      pr_number: ${{ steps.create_pr.outputs.pr_number }}
      pr_url: ${{ steps.create_pr.outputs.pr_url }}
      branch_name: ${{ steps.create_pr.outputs.branch_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Download phase-3 artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: codex-phase3
          path: target/codex-workflow/from-phase3

      - name: Apply cumulative patch from phase3
        shell: bash
        run: |
          set -euo pipefail
          patch_file="target/codex-workflow/from-phase3/target/codex-workflow/output/phase3-cumulative.patch"
          if [[ ! -f "${patch_file}" ]]; then
            echo "Missing patch: ${patch_file}" >&2
            exit 1
          fi
          if [[ -s "${patch_file}" ]]; then
            git apply --whitespace=nowarn "${patch_file}"
          else
            echo "phase3 patch is empty; skipping apply."
          fi

      - name: Create app token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ vars.APP_ID_CODEX }}
          private-key: ${{ secrets.PRIVATE_KEY_CODEX }}

      - name: Commit, push, and create PR
        id: create_pr
        env:
          RULE_ID: ${{ needs.phase3_impl.outputs.rule_id }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if [[ -z "$(git status --porcelain)" ]]; then
            echo "No changes found after phase3; PR cannot be created." >&2
            exit 1
          fi

          branch_name="codex/${RULE_ID}-${GITHUB_RUN_ID}"
          run_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          git switch -c "${branch_name}"
          git add -A
          git commit -m "feat(rules): add ${RULE_ID} via codex workflow"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git push --set-upstream origin "${branch_name}"

          pr_url="$(gh pr create \
            --base "${DEFAULT_BRANCH}" \
            --head "${branch_name}" \
            --title "feat(rules): add ${RULE_ID}" \
            --body "Generated by rule-authoring-codex workflow run: ${run_url}")"
          pr_number="$(gh pr view "${pr_url}" --json number --jq '.number')"

          {
            echo "branch_name=${branch_name}"
            echo "pr_url=${pr_url}"
            echo "pr_number=${pr_number}"
          } >> "${GITHUB_OUTPUT}"

  phase4_verify:
    runs-on: ubuntu-latest
    needs: [phase3_impl, pr_open]
    permissions:
      contents: read
    outputs:
      rule_id: ${{ needs.phase3_impl.outputs.rule_id }}
      rule_idea: ${{ needs.phase3_impl.outputs.rule_idea }}
      recommendation: ${{ steps.verify_gate.outputs.recommendation }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Download phase-3 artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: codex-phase3
          path: target/codex-workflow/from-phase3

      - name: Apply cumulative patch from phase3
        shell: bash
        run: |
          set -euo pipefail
          patch_file="target/codex-workflow/from-phase3/target/codex-workflow/output/phase3-cumulative.patch"
          if [[ ! -f "${patch_file}" ]]; then
            echo "Missing patch: ${patch_file}" >&2
            exit 1
          fi
          if [[ -s "${patch_file}" ]]; then
            git apply --whitespace=nowarn "${patch_file}"
          else
            echo "phase3 patch is empty; skipping apply."
          fi

      - name: Restore verify-input from phase3 artifacts
        shell: bash
        run: |
          set -euo pipefail
          rm -rf verify-input
          if [[ -d target/codex-workflow/from-phase3/verify-input ]]; then
            cp -R target/codex-workflow/from-phase3/verify-input ./verify-input
          else
            echo "verify-input not found in phase3 artifact; creating empty directory."
            mkdir -p verify-input/reports
          fi

      - name: Write phase-4 prompt (verify only)
        env:
          RULE_ID: ${{ needs.phase3_impl.outputs.rule_id }}
        run: |
          mkdir -p target/codex-workflow/prompts target/codex-workflow/output
          cat > target/codex-workflow/prompts/phase4-verify.md <<EOF
          You are Codex in this repository.

          Use \`./prompts/authoring-verify.md\` as the base prompt and follow it strictly.

          Inputs:
          - rule-id: ${RULE_ID}
          - verify directory: verify-input/

          Phase scope:
          1. Verify using only files under \`verify-input/\`.
          2. Write report to \`verify-input/verify-report.md\`.
          3. Do not modify implementation in this phase.

          Final response format (strict):
          recommendation: <Go|No-Go>
          report-path: verify-input/verify-report.md
          EOF

      - name: Phase 4 - Verify from Spec and verify-input
        id: codex_phase4
        uses: openai/codex-action@086169432f1d2ab2f4057540b1754d550f6a1189 # v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          safety-strategy: drop-sudo
          prompt-file: target/codex-workflow/prompts/phase4-verify.md
          output-file: target/codex-workflow/output/phase4-final-message.txt
          sandbox: workspace-write
          codex-args: --full-auto

      - name: Evaluate verify recommendation
        id: verify_gate
        shell: bash
        run: |
          set -euo pipefail
          recommendation="No-Go"
          report_path="verify-input/verify-report.md"
          if [[ -f "${report_path}" ]]; then
            parsed="$(awk '/^## Recommendation \(Go\/No-Go\)/ {getline; gsub(/\r/, ""); print; exit}' "${report_path}" | xargs || true)"
            if [[ "${parsed}" == "Go" || "${parsed}" == "No-Go" ]]; then
              recommendation="${parsed}"
            fi
          fi

          {
            echo "recommendation=${recommendation}"
          } >> "${GITHUB_OUTPUT}"

      - name: Capture cumulative patch (phase4)
        shell: bash
        run: |
          set -euo pipefail
          git add -A
          git diff --cached --binary > target/codex-workflow/output/phase4-cumulative.patch

      - name: Upload phase-4 artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: codex-phase4
          path: |
            target/codex-workflow/prompts/phase4-verify.md
            target/codex-workflow/output/phase4-final-message.txt
            target/codex-workflow/output/phase4-cumulative.patch
            verify-input/
          if-no-files-found: warn

      - name: Workflow summary
        if: always()
        run: |
          {
            echo "## Codex rule authoring workflow"
            echo ""
            echo "- rule-id: \`${{ needs.phase3_impl.outputs.rule_id || 'unknown' }}\`"
            echo "- pr-number: \`${{ needs.pr_open.outputs.pr_number || 'unknown' }}\`"
            echo "- recommendation: \`${{ steps.verify_gate.outputs.recommendation || 'unknown' }}\`"
          } >> "${GITHUB_STEP_SUMMARY}"

  pr_finalize:
    runs-on: ubuntu-latest
    needs: [phase4_verify, pr_open]
    if: always() && needs.phase4_verify.result == 'success' && needs.pr_open.result == 'success'
    environment: codex
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Create app token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ vars.APP_ID_CODEX }}
          private-key: ${{ secrets.PRIVATE_KEY_CODEX }}

      - name: Checkout default branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false
          ref: ${{ github.event.repository.default_branch }}
          token: ${{ steps.app-token.outputs.token }}

      - name: Download phase-4 artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: codex-phase4
          path: target/codex-workflow/from-phase4

      - name: Extract No-Go reason summary
        id: no_go_summary
        if: needs.phase4_verify.outputs.recommendation == 'No-Go'
        shell: bash
        run: |
          set -euo pipefail
          report_path="target/codex-workflow/from-phase4/verify-input/verify-report.md"
          reason=""
          if [[ -f "${report_path}" ]]; then
            reason="$(awk '
              /^## Recommendation \(Go\/No-Go\)/ {exit}
              /^## / {in_section=1; next}
              in_section == 1 {
                line=$0
                gsub(/\r/, "", line)
                if (line ~ /^[[:space:]]*$/) next
                sub(/^[[:space:]]*[-*][[:space:]]*/, "", line)
                if (line ~ /^No findings/ || line ~ /^None\.?$/) next
                print line
                exit
              }
            ' "${report_path}" | sed -E 's/[[:space:]]+/ /g; s/[[:space:]]+$//')"
          fi

          if [[ -z "${reason}" ]]; then
            reason="Verification returned No-Go. Inspect verify-input/verify-report.md for details."
          fi

          {
            echo "reason<<EOF"
            echo "${reason}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Record No-Go history on default branch
        if: needs.phase4_verify.outputs.recommendation == 'No-Go'
        env:
          RULE_ID: ${{ needs.phase4_verify.outputs.rule_id }}
          RULE_IDEA: ${{ needs.phase4_verify.outputs.rule_idea }}
          NO_GO_REASON: ${{ steps.no_go_summary.outputs.reason }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          mkdir -p "$(dirname "${NO_GO_HISTORY_PATH}")"
          if [[ ! -f "${NO_GO_HISTORY_PATH}" ]]; then
            {
              echo "# Rule Ideation No-Go History"
              echo ""
              echo "This reference is used by \`prompts/ideate-rule.md\` to avoid proposing duplicate or low-value rule ideas."
              echo "Append one entry each time verify returns \`No-Go\`."
              echo ""
              echo "## Entry format"
              echo "- \`rule-id\`: snake_case identifier"
              echo "- \`rule idea\`: short summary used in ideation"
              echo "- \`no-go reason\`: concise reason summary from verify"
              echo "- \`run-url\`: GitHub Actions run URL for traceability"
              echo ""
              echo "## Entries"
            } > "${NO_GO_HISTORY_PATH}"
          fi

          entry_time="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          run_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          {
            echo ""
            echo "## ${entry_time} | ${RULE_ID}"
            echo "- rule-id: \`${RULE_ID}\`"
            echo "- rule idea: ${RULE_IDEA}"
            echo "- no-go reason: ${NO_GO_REASON}"
            echo "- run-url: ${run_url}"
          } >> "${NO_GO_HISTORY_PATH}"

          git add "${NO_GO_HISTORY_PATH}"
          git commit -m "docs(prompts): record no-go rule ${RULE_ID}"

          pushed="false"
          for attempt in 1 2 3; do
            if git push origin "HEAD:${DEFAULT_BRANCH}"; then
              pushed="true"
              break
            fi
            if [[ "${attempt}" -lt 3 ]]; then
              git fetch origin "${DEFAULT_BRANCH}"
              git rebase "origin/${DEFAULT_BRANCH}"
            fi
          done

          if [[ "${pushed}" != "true" ]]; then
            echo "Failed to push No-Go history update after retries." >&2
            exit 1
          fi

      - name: Close PR and delete branch on No-Go
        if: needs.phase4_verify.outputs.recommendation == 'No-Go'
        env:
          PR_NUMBER: ${{ needs.pr_open.outputs.pr_number }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        shell: bash
        run: |
          set -euo pipefail
          gh pr close "${PR_NUMBER}" --delete-branch --comment "Closing automatically because verify recommendation is No-Go."

      - name: Enable PR auto-merge on Go
        if: needs.phase4_verify.outputs.recommendation == 'Go'
        env:
          PR_NUMBER: ${{ needs.pr_open.outputs.pr_number }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        shell: bash
        run: |
          set -euo pipefail
          gh pr merge "${PR_NUMBER}" --auto --squash --delete-branch

      - name: Final workflow summary
        if: always()
        run: |
          {
            echo "## PR finalize"
            echo ""
            echo "- pr-number: \`${{ needs.pr_open.outputs.pr_number || 'unknown' }}\`"
            echo "- recommendation: \`${{ needs.phase4_verify.outputs.recommendation || 'unknown' }}\`"
            if [[ "${{ needs.phase4_verify.outputs.recommendation }}" == "Go" ]]; then
              echo "- action: \`auto-merge enabled\`"
            else
              echo "- action: \`closed and branch deleted\`"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"
